<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bootstrap Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container-fluid p-2 my-2">
    <h1 class="display-4 text-dark text-center">Worker Asistan</h1>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm">
            <div class="row">
                <div class="col mt-2">
                    <div class="col">Makine Durumu:</div>
                    <div class="col"><h4 id="state">Bilinmiyor</h4></div>
                </div>
            </div>
        </div>
        <div class="col-sm">
            <div class="row">
                <div class="col mt-2 text-center">
                    <h4 id="productPart">Üretilecek Parça Seçilmedi</h4>
                </div>
            </div>
        </div>
        <div class="col-sm">
            <label for="selectMachine" class="d-none"></label>
            <select class="form-select" id="selectMachine" onchange="selectMachine()">
                <option value="0" hidden="">Lütfen Buradan Seçim Yapınız</option>
            </select>
        </div>
    </div>
    <div class="row border-top border-1 border-secondary ">
        <div class="col-sm m-2">
            <div class="row mt-3"><h4>Üretim Emri Seç</h4></div>
            <div class="row mt-1 mb-3">
                <label for="selectOrder" class="d-none"></label>
                <select class="form-select" id="selectOrder">
                    <option value="0" hidden="">Buradan Üretim Emri Seçiniz</option>
                </select>
            </div>
            <div class="row mt-1">
                <button type="button" onclick="setOrder()" class="uBtn btn btn-primary text-center col-12 p-3"><span class="h5">Üretim Emri Seç</span></button>
            </div>
        </div>
        <div class="col-sm">
            <div class="row mt-3">
              <button type="button" value="10000" class="btn btn-success btn-block text-center mt-3 p-5 col-12" onclick="startWork(this);" data-zed="start"><span class="display-4">Üretim Başlat</span></button>
            </div>
        </div>
        <div class="col-sm m-2">
            <div class="row mt-1">
                <div class="col-sm"><h6>Hedef Parça</h6></div>
                <div class="col-sm"><h3 class="text-info"><span id="target">0</span> Adet</h3></div>
            </div>
            <div class="row mt-1">
                <div class="col-sm"><h6>Sağlam Parça Sayısı</h6></div>
                <div class="col-sm"><h3 class="text-success"><span id="good">0</span> Adet</h3></div>
            </div>
            <div class="row mt-1">
                <div class="col-sm"><h6>Hurda/Fire Parça Sayısı</h6></div>
                <div class="col-sm"><h3 class="text-danger"><span id="reject">0</span> Adet</h3></div>
            </div>
            <div class="row mt-1">
                <div class="col">
                    <button type="button" class="sBtn btn btn-success text-center col-12 p-4" onclick="jobControlBtn(this);" data-pub="s" disabled><span class="h6">Sağlam Parça</span></button>
                </div>
                <div class="col">
                    <button type="button" class="hBtn btn btn-danger text-center col-12 p-4" onclick="jobControlBtn(this);" data-pub="h" disabled><span class="h6">Hurda/Fire Parça</span></button>
                </div>
                <div class="col">
                    <button type="button" class="kBtn btn btn-warning text-center col-12 p-4" onclick="jobControlBtn(this);" data-pub="k" disabled><span class="h6">Kayıt Et</span></button>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="row border-top border-1 border-secondary bg-light bg-gradient" style="height: 10em">
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-primary btn-block text-center col-12" onclick="jbButton(this)" data-val="10000"><span class="h1">Makine Çalışıyor</span></button>
            </div>
        </div>
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-success btn-block text-center col-12" onclick="jbButton(this)" data-val="150000"><span class="h1">Mola</span></button>
            </div>
        </div>
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-warning btn-block text-center col-12" onclick="jbButton(this)" data-val="100000"><span class="h1">Model Değişimi</span></button>
            </div>
        </div>
    </div>
    <div class="row bg-light bg-gradient" style="height: 10em">
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-danger btn-block text-center col-12" onclick="jbButton(this);" data-val="220000"><span class="h1">Arıza</span></button>
            </div>
        </div>
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-danger btn-block text-center col-12" onclick="jbButton(this);" data-val="170000"><span class="h1">Sipariş Yok</span></button>
            </div>
        </div>
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-danger btn-block text-center col-12" onclick="jbButton(this);" data-val="90000"><span class="h1">Hammadde Yok</span></button>
            </div>
        </div>
    </div>
    <div class="row bg-light bg-gradient" style="height: 10em">
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-primary btn-block text-center col-12" onclick="jbButton(this);" data-val="0"><span class="h1">&nbsp;</span></button>
            </div>
        </div>
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" value="30000" class="btn btn-outline-info btn-block text-center col-12" onclick="jbButton(this);" data-val="0"><span class="h1">Diğer</span></button>
            </div>
        </div>
        <div class="col m-2">
            <div class="d-grid h-100">
                <button type="button" class="btn btn-outline-warning btn-block text-center col-12" onclick="jbButton(this);" data-val="0"><span class="h1">&nbsp;</span></button>
            </div>
        </div>
    </div>
</div>

</body>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="http://scottoffen.github.io/jquery.toaster/jquery.toaster.js"></script>
<script type="text/javascript">
    /*
     * let hostUrl = 'http://localhost:1880/nodered/';
     */

    let hostUrl = 'http://192.168.10.226:1880/nodered/';
    let makine = "", state = "", status = "", orderList = [], selectOrderID = "";

    $(document).ready(function () {
        listMachine();
    });

    function jobControlBtn(identifier) {
        let buttonName = $(identifier).data("pub");
        let target = $('#target'), good = $('#good'), reject = $('#reject');
        let totals = parseInt(good.html()) + parseInt(reject.html());

        target.html(10);
        if(buttonName === "s"){
            if(parseInt(target.html()) === parseInt(good.html())){
                //  || totals === parseInt(target.html())
                $('.sBtn, .hBtn').prop('disabled',true); $('.kBtn').removeAttr('disabled');
                $.toaster({ message : 'Eşitlendi', title : 'Bilgilendirme', priority : 'warning' });
            }
            else {
                good.html(parseInt(good.html()) + 1);
                $.toaster({ message : 'Devam', title : 'Bilgilendirme', priority : 'info' });
                if(parseInt(target.html()) === parseInt(good.html())){
                    // || totals === parseInt(target.html())
                    $('.sBtn, .hBtn').prop('disabled',true); $('.kBtn').removeAttr('disabled');
                }
            }
        }
        else if(buttonName === "h"){
            //if(parseInt(reject.html()) === parseInt(target.html()) || totals === parseInt(target.html())){
            //    $.toaster({ message : 'Daha fazla Hurda Parça Çıkarılamaz!', title : 'Bilgilendirme', priority : 'warning' });
            //}
            // else {
                reject.html(parseInt(reject.html()) + 1);
                $.toaster({ message : reject.html() + " adet hurda", title : 'Bilgilendirme', priority : 'info' });
            // }
        }
        else if(buttonName === "k"){
            $.ajax({
                headers: {"Accept":"application/json"},
                cache: false,
                url: hostUrl + 'countByMachine/',
                data: {
                    'machine': makine,
                    'total': parseInt(good.html()) + parseInt(reject.html()),
                    'hurda': reject.html()
                },
                method: 'post',
                success: function(data) {
                    target.html("0"); good.html("0"); reject.html("0");
                    $.toaster({ message : good.html() + " adet kayıt Yapıldı!", title : 'Bilgilendirme', priority : 'success' });
                    console.log(data);
                }
            });
        }
        else {
            $.toaster({ message : "Nope!", title : 'Bilgilendirme', priority : 'danger' });
        }
    }

    function jbButton(identifier) {
        var nData = $(identifier).data("val");

        $.ajax({
            headers: {"Accept":"application/json"},
            cache: false,
            url: hostUrl + 'setStateByMachine/',
            data: {
                'machine': $('#selectMachine').val(), 
                'state': nData
            },
            method: 'post',
            success: function(data) {
                $.toaster({ message : nData + " olarak değiştirildi!", title : 'Bilgilendirme', priority : 'danger' });
                console.log(data);
            }
        });

    }

    function startWork(identifier){
        if($(identifier).attr('zed') === "end"){
            let target = $('#target'), good = $('#good'), reject = $('#reject');
            target.html("0"); good.html("0"); reject.html("0");
            $('#selectOrder, .uBtn').removeAttr('disabled');
            $(".sBtn, .hBtn, .kBtn").prop('disabled',true);
            $(identifier).removeClass('btn-danger').addClass('btn-success').html('<span class="display-4">Üretim Başlat</span>');
            $(identifier).attr('zed', 'end');

            $.ajax({
                headers: {"Accept":"application/json"},
                cache: false,
                url: hostUrl + 'endOderByMachine/',
                data: {'machine': makine, 'orderID': selectOrderID},
                method: 'post',
                success: function(data) {
                    $.toaster({ message : "İşlem başarılı!", title : 'Bilgilendirme', priority : 'success' });
                    console.log(data);
                }
            });
        }
        else {
            $.ajax({
                headers: {"Accept":"application/json"},
                cache: false,
                url: hostUrl + 'startOderByMachine/',
                data: {'machine': makine, 'orderID': selectOrderID},
                method: 'post',
                success: function(data) {
                    $.toaster({ message : "İşlem başarılı!", title : 'Bilgilendirme', priority : 'success' });
                    console.log(data);
                }
            });

            $(identifier).attr('zed', 'end');
            $('#selectOrder, .uBtn').prop('disabled',true);
            $(".sBtn, .hBtn").removeAttr('disabled');
            $(identifier).removeClass('btn-success').addClass('btn-danger').html('<span class="display-4">Üretimi Bitir</span>');
        }

    }

    function listMachine() {
        $.ajax({
            type: 'GET',
            //url: 'http://192.168.10.226:1880/nodered/listMachine',
            url: hostUrl + 'listMachine',
            success: function (result) {
                for (x = 0; x < result.length; x++) {
                    console.log();
                    item = document.getElementById("selectMachine");
                    option = document.createElement("option");
                    option.value = result[x];
                    option.text = result[x];
                    item.add(option);
                }
            },
            complete: function (result) {
                // Schedule the next
            }
        });
    }

    function selectMachine() {
        makine = document.getElementById("selectMachine").value;
        console.log(makine)
        $('#selectOrder').find('option[value]').remove();
        selectOrder(makine)
        doAjax();
    }

    function setState(state) {
        document.getElementById('state').innerHTML = "<h4>" + state + "</h4>"
    }

    function setOrder() {

        x = document.getElementById('selectOrder').value
        console.log(orderList)

        selectOrderText = orderList[x]["1"]
        selectOrderID = orderList[x]["0"]
        console.log(selectOrderID)
        selectOrderTarget = orderList[x]["2"]

        document.getElementById('target').innerHTML = selectOrderTarget;
        document.getElementById('productPart').innerHTML = "<h3>" + selectOrderText + " Üretimine Aşağıdan Başlayabilirsin </h3>";
    }

    function selectOrder(makine) {
        orderList = []
        $.ajax({
            type: 'GET',
            url: hostUrl + 'orderSelectbyMachine',
            data: {
                "machine": makine,
            },
            dataType: 'json',
            success: function (result) {
                for (x = 0; x <= result.length + 1; x++) {
                    console.log(result[x]);
                    item = document.getElementById("selectOrder");
                    option = document.createElement("option");
                    option.value = x;
                    option.text = result[x]["1"];
                    item.add(option);
                    orderList.push(result[x])
                }
                option.value = "";
                option.text = "Üretim Emri Seçiniz";
                option.selected = "selected"
                item.add(option);
                
            },
            complete: function (result) {
                // Schedule the next
            }
        });
    }

    function girisYap(param1) {
        status = param1;
        //console.log(deger1)
    }

    function doAjax() {
        $.ajax({
            type: 'GET',
            url: hostUrl + 'checkMachineState',
            data: {
                "machine": makine,
            },
            dataType: 'json',
            success: function (result) {
                //console.log(result)
                setState(result["state"])
            },
            complete: function (result) {
                // Schedule the next
                setTimeout(doAjax, 3000);
            }
        });
    }

    setTimeout(doAjax, 3000);
</script>
</html>
